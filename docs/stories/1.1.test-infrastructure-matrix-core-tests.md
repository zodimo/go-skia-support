<!-- Powered by BMAD™ Core -->

# Story 1.1: Test Infrastructure Setup and Matrix Core Tests

## Status
Draft

---

## Story

**As a** developer working on the Go-Skia-Support project,  
**I want** comprehensive test infrastructure with tolerance-based comparison utilities and core Matrix test cases ported from Skia C++ test suite,  
**so that** I can verify functional parity and calculation accuracy of the Matrix implementation against the reference C++ implementation.

---

## Acceptance Criteria

1. Test helper utilities (`test_helpers.go`) created with floating-point comparison functions that support tolerance-based comparisons
2. Core Matrix tests ported from `MatrixTest.cpp`:
   - Matrix inversion tests (`DEF_TEST(Matrix, reporter)`)
   - Matrix concatenation tests (`DEF_TEST(Matrix_Concat, r)`)
   - Matrix mapRect tests (`DEF_TEST(Matrix_maprects, r)`)
   - Matrix getter/setter tests (`test_set9`)
3. Test coverage for `matrix_helpers.go` functions (e.g., `rowcol3`, `muladdmul`, `scross_dscale`)
4. Test coverage for matrix-related model operations (Point, Rect transformations)
5. All ported tests pass with acceptable floating-point tolerance
6. Test infrastructure integrates with standard Go tooling (`go test`)
7. Test files follow Go conventions (`*_test.go`) and are located alongside implementations

---

## Tasks / Subtasks

- [ ] Task 1: Create Test Infrastructure (AC: 1, 6, 7)
  - [ ] Create `skia/impl/test_helpers.go` file with tolerance-based comparison utilities
  - [ ] Implement `NearlyEqualScalar()` function for floating-point comparison with tolerance (reference Skia epsilon values)
  - [ ] Implement `NearlyEqual()` function for Matrix comparison with tolerance
  - [ ] Implement `IsIdentity()` helper function for identity matrix checks
  - [ ] Add test constants for tolerance thresholds (reference Skia's epsilon values from C++ source)
  - [ ] Document tolerance thresholds and acceptable deviations
  - [ ] Verify test infrastructure integrates with `go test` command

- [ ] Task 2: Port Core Matrix Inversion Tests (AC: 2)
  - [ ] Review `skia-source/tests/MatrixTest.cpp` `DEF_TEST(Matrix, reporter)` function
  - [ ] Port matrix inversion test cases to `skia/impl/matrix_test.go`
  - [ ] Test `Invert()` method with various matrix types (affine, perspective, identity)
  - [ ] Test inversion of singular matrices (should return false)
  - [ ] Test round-trip: `M * M^-1 == I` (within tolerance)
  - [ ] Verify test results match C++ test expectations (within tolerance)

- [ ] Task 3: Port Matrix Concatenation Tests (AC: 2)
  - [ ] Review `skia-source/tests/MatrixTest.cpp` `DEF_TEST(Matrix_Concat, r)` function
  - [ ] Port matrix concatenation test cases to `skia/impl/matrix_test.go`
  - [ ] Test `SetConcat()` method with various matrix combinations
  - [ ] Test associativity property: `(A * B) * C == A * (B * C)` (within tolerance)
  - [ ] Test identity matrix concatenation: `M * I == I * M == M`
  - [ ] Test concatenation with scale+translate optimization paths
  - [ ] Verify test results match C++ test expectations

- [ ] Task 4: Port Matrix MapRect Tests (AC: 2)
  - [ ] Review `skia-source/tests/MatrixTest.cpp` `DEF_TEST(Matrix_maprects, r)` function
  - [ ] Port matrix mapRect test cases to `skia/impl/matrix_test.go`
  - [ ] Test `MapRect()` method with various matrix types
  - [ ] Test rect transformation with identity, scale, rotate, translate matrices
  - [ ] Test edge cases: empty rects, zero-area rects, negative rects
  - [ ] Test perspective matrix rect mapping (if applicable)
  - [ ] Verify test results match C++ test expectations

- [ ] Task 5: Port Matrix Getter/Setter Tests (AC: 2)
  - [ ] Review `skia-source/tests/MatrixTest.cpp` `test_set9` function
  - [ ] Port matrix getter/setter test cases to `skia/impl/matrix_test.go`
  - [ ] Test `Set9()` method with identity matrix
  - [ ] Test `Set9()` method with scale matrix
  - [ ] Test `Set9()` after post-translate operations
  - [ ] Test `Get9()` returns correct values matching `Set9()` input
  - [ ] Test `RC()` accessor matches `Get9()` values
  - [ ] Verify test results match C++ test expectations

- [ ] Task 6: Test Matrix Helper Functions (AC: 3)
  - [ ] Review `skia/impl/matrix_helpers.go` to identify all helper functions
  - [ ] Create test cases for `rowcol3()` helper function
  - [ ] Create test cases for `muladdmul()` helper function
  - [ ] Create test cases for `scross_dscale()` helper function
  - [ ] Test helper functions with various input combinations
  - [ ] Test edge cases for helper functions (zero values, near-zero values)
  - [ ] Verify helper functions produce correct results

- [ ] Task 7: Test Matrix-Related Model Operations (AC: 4)
  - [ ] Review `skia/models/point.go` to identify Point transformation operations
  - [ ] Review `skia/models/rect.go` to identify Rect transformation operations
  - [ ] Create test cases for Point transformation via Matrix (`MapPoint`, `MapPoints`)
  - [ ] Create test cases for Rect transformation via Matrix (`MapRect`)
  - [ ] Test model operations with various matrix types
  - [ ] Test edge cases: zero points, empty rects, degenerate cases
  - [ ] Verify model operations produce correct results matching C++ behavior

- [ ] Task 8: Verify Test Execution and Coverage (AC: 5, 6)
  - [ ] Run all tests: `go test ./skia/impl/...`
  - [ ] Verify all tests pass with acceptable tolerance
  - [ ] Generate test coverage report: `go test -cover ./skia/impl/...`
  - [ ] Document any test failures or precision deviations
  - [ ] Update tolerance thresholds if needed based on test results
  - [ ] Ensure test files compile without errors

---

## Dev Notes

### Previous Story Insights
No previous stories exist - this is the first story in Epic 1.

### Data Models
[Source: architecture/source-tree.md#models]

**Point Model** (`skia/models/point.go`):
- Structure: `Point` with `X`, `Y` fields (both `Scalar`/`float32`)
- Used by Matrix for point transformation operations (`MapPoint`, `MapPoints`)
- C++ equivalent: `include/core/SkPoint.h`

**Rect Model** (`skia/models/rect.go`):
- Structure: `Rect` with `Left`, `Top`, `Right`, `Bottom` fields (all `Scalar`/`float32`)
- Used by Matrix for rect transformation operations (`MapRect`)
- C++ equivalent: `include/core/SkRect.h`

### API Specifications
[Source: architecture/source-tree.md#interfaces]

**Matrix Interface** (`skia/interfaces/matix.go`):
- Public API matching Skia C++ `SkMatrix` interface
- Key methods to test:
  - `Invert() (Matrix, bool)` - Matrix inversion
  - `SetConcat(a, b Matrix) Matrix` - Matrix concatenation
  - `MapRect(r Rect) Rect` - Rect transformation
  - `MapPoint(pt Point) Point` - Point transformation
  - `MapPoints(pts []Point) []Point` - Batch point transformation
  - `Set9(values [9]Scalar) Matrix` - Set from 9-element array
  - `Get9() [9]Scalar` - Get 9-element array
  - `RC(row, col int) Scalar` - Row/column accessor

### Component Specifications
[Source: architecture/source-tree.md#impl]

**Matrix Implementation** (`skia/impl/matrix.go`):
- Main implementation file (~725 lines)
- Implements `SkMatrix` interface
- C++ equivalent: `src/core/SkMatrix.cpp` (~1800 lines)

**Matrix Helpers** (`skia/impl/matrix_helpers.go`):
- Helper functions for matrix operations:
  - `rowcol3()` - Row/column operations
  - `muladdmul()` - Multiply-add-multiply operations
  - `scross_dscale()` - Scalar cross product with scale
- These helpers need independent test coverage

### File Locations
[Source: architecture/source-tree.md#test-organization]

**Test Files to Create:**
- `skia/impl/test_helpers.go` - Test infrastructure utilities
- `skia/impl/matrix_test.go` - Matrix test cases

**Test File Naming:**
- Test files: `*_test.go` alongside implementation
- Test package: `package impl_test` or `package impl` (as appropriate)
- Test naming: `TestFunctionName` or `TestMethodName_Scenario`

### Testing Requirements
[Source: architecture/coding-standards.md#testing-standards]

**Test Organization:**
- Test files: `*_test.go` alongside implementation
- Test package: `package impl_test` or `package impl` (as appropriate)
- Test naming: `TestFunctionName` or `TestMethodName_Scenario`

**Test Requirements:**
1. Port Skia Tests: All tests from `docs/cpp-test-reference.md` must be ported
2. Edge Cases: Test all edge cases from C++ tests
3. Precision Tests: Verify floating-point accuracy
4. Dependent Component Coverage: Tests must extend to all dependent components:
   - Test helper functions (`matrix_helpers.go`) independently
   - Test model operations (Point, Rect) used by implementations
   - Verify integration between components

**Test Helpers:**
- Use tolerance-based comparison for floating-point
- Create test utilities matching Skia's test helpers
- Reference: `docs/cpp-test-reference.md` for helper functions

**Test Coverage Scope:**
- Direct Tests: Test public API methods directly
- Helper Tests: Test helper functions independently
- Model Tests: Test model operations used by implementations
- Integration Tests: Verify components work together correctly

### Technical Constraints
[Source: architecture/coding-standards.md#floating-point-precision]

**Floating-Point Precision:**
- Use `float32` (Go `Scalar`) to match C++ `float`
- Document acceptable tolerance for comparisons
- Test with Skia's test vectors
- Tolerance thresholds should reference Skia's epsilon values from C++ source

**Edge Cases:**
- Handle NaN and Inf gracefully
- Check for zero division before division operations
- Handle empty inputs gracefully

[Source: architecture/tech-stack.md#testing]

**Testing Framework:**
- Standard Go `testing` package
- Use `go test` for test execution
- Use `go test -cover` for coverage reports

### Reference Documents
[Source: architecture/coding-standards.md#references]

**C++ Test Reference:**
- `docs/cpp-test-reference.md` - Complete C++ test reference guide
- Matrix tests: `skia-source/tests/MatrixTest.cpp`
- Test helper functions to port: `nearly_equal_scalar()`, `nearly_equal()`, `is_identity()`

**C++ Source Reference:**
- Skia C++ source: `/home/jaco/SecondBrain/1-Projects/GoProjects/Development/skia-source`
- Matrix implementation: `src/core/SkMatrix.cpp`
- Matrix header: `include/core/SkMatrix.h`

**Verification Plan:**
- `docs/functional-parity-verification-plan.md` - Comprehensive verification strategy

### Project Structure Notes
[Source: architecture/source-tree.md]

All file locations align with defined project structure:
- Test files in `skia/impl/` alongside implementations ✅
- Helper utilities in same package as tests ✅
- Models in `skia/models/` as separate package ✅

---

## Testing

### Test File Location
[Source: architecture/coding-standards.md#test-organization]
- Test files: `*_test.go` alongside implementation in `skia/impl/`
- Test infrastructure: `skia/impl/test_helpers.go`

### Test Standards
[Source: architecture/coding-standards.md#testing-standards]
- Port tests from `docs/cpp-test-reference.md`
- Use tolerance-based comparison for floating-point
- Test all edge cases from C++ tests
- Test dependent components (helpers, models) independently

### Testing Frameworks
[Source: architecture/tech-stack.md#testing]
- Standard Go `testing` package
- No external testing dependencies required

### Specific Testing Requirements for This Story
1. **Tolerance-Based Comparison:**
   - Implement floating-point comparison with configurable tolerance
   - Reference Skia's epsilon values from C++ source
   - Document acceptable deviations

2. **Test Coverage:**
   - Core Matrix API methods (inversion, concatenation, mapRect, getters/setters)
   - Matrix helper functions (`matrix_helpers.go`)
   - Matrix-related model operations (Point, Rect transformations)

3. **Test Data:**
   - Extract test matrices from C++ test cases
   - Use test vectors from `MatrixTest.cpp`
   - Include edge cases: identity, scale, rotate, translate, perspective matrices

4. **Precision Verification:**
   - Verify floating-point accuracy within acceptable tolerance
   - Test round-trip operations (e.g., `M * M^-1 == I`)
   - Document any precision deviations

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Product Owner |

---

## Dev Agent Record

### Agent Model Used
_To be populated by development agent during implementation_

### Debug Log References
_To be populated by development agent during implementation_

### Completion Notes List
_To be populated by development agent during implementation_

### File List
_To be populated by development agent during implementation_

---

## QA Results
_To be populated by QA agent after story completion_

