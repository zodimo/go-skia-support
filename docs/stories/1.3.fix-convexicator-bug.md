<!-- Powered by BMADâ„¢ Core -->

# Story 1.3: Fix Convexicator Concave Shape Detection Bug

## Status
Draft

---

## Story

**As a** developer working on the Go-Skia-Support project,  
**I want** the convexicator implementation to correctly detect concave shapes and self-intersecting paths,  
**so that** path convexity tests in story 1.2 can be completed and path convexity detection matches the Skia C++ reference implementation.

---

## Acceptance Criteria

1. Convexicator `addVec()` method correctly detects direction changes that indicate concave shapes
2. Convexicator `close()` method correctly validates the closing edge for concave detection
3. Convexicator correctly handles backwards direction changes (reversals) matching C++ implementation
4. Convexicator `addPt()` method correctly initializes first vector state
5. All previously skipped concave shape tests in `path_test.go` pass
6. All previously skipped self-intersecting path tests in `path_test.go` pass
7. Existing convex shape tests continue to pass (no regression)
8. Implementation matches C++ `Convexicator` behavior from `skia-source/src/core/SkPathPriv.cpp`

---

## Tasks / Subtasks

- [ ] Task 1: Analyze C++ Convexicator Implementation (AC: 8)
  - [ ] Review `skia-source/src/core/SkPathPriv.cpp` Convexicator struct (lines 419-560)
  - [ ] Review `directionChange()` method implementation
  - [ ] Review `addVec()` method implementation
  - [ ] Review `addPt()` method implementation
  - [ ] Review `close()` method implementation
  - [ ] Document differences between Go and C++ implementations

- [ ] Task 2: Fix Convexicator `addVec()` Method (AC: 1, 3)
  - [ ] Fix direction change detection logic
  - [ ] Fix backwards direction change handling (reversals)
  - [ ] Ensure reversal count logic matches C++ (`return ++fReversals < 3`)
  - [ ] Verify expected direction tracking works correctly
  - [ ] Test with concave shapes (bow-tie, dent, spiral)

- [ ] Task 3: Fix Convexicator `close()` Method (AC: 2)
  - [ ] Ensure `close()` correctly calls `addVec(fFirstVec)` after `addPt(fFirstPt)`
  - [ ] Verify closing edge direction change detection
  - [ ] Test with paths that are concave at the closing edge

- [ ] Task 4: Fix Convexicator `addPt()` Method (AC: 4)
  - [ ] Fix first vector initialization logic
  - [ ] Ensure zero vector handling matches C++ (`fLastVec.equals(0,0)` check)
  - [ ] Verify first vector is correctly set when path starts

- [ ] Task 5: Fix Convexicator `directionChange()` Method (AC: 1)
  - [ ] Verify cross product calculation matches C++ (`SkPoint::CrossProduct`)
  - [ ] Verify direction sign calculation (`SkScalarSignAsInt(cross)`)
  - [ ] Ensure backwards detection uses dot product correctly
  - [ ] Test edge cases (zero cross product, infinite values)

- [ ] Task 6: Re-enable and Verify Concave Shape Tests (AC: 5)
  - [ ] Remove skip statements from concave quadrilateral test
  - [ ] Remove skip statements from bow-tie test
  - [ ] Remove skip statements from spiral test
  - [ ] Remove skip statements from dent test
  - [ ] Verify all concave shape tests pass

- [ ] Task 7: Re-enable and Verify Self-Intersecting Path Tests (AC: 6)
  - [ ] Remove skip statements from self-intersecting path tests
  - [ ] Verify self-intersecting paths are correctly detected as concave
  - [ ] Verify all self-intersecting path tests pass

- [ ] Task 8: Regression Testing (AC: 7)
  - [ ] Run all existing convex shape tests
  - [ ] Verify all convex shape tests still pass
  - [ ] Verify triangle, square, circle tests still pass
  - [ ] Verify convexity caching tests still pass
  - [ ] Document any test result changes

---

## Dev Notes

### Story Context

**Existing System Integration:**
- Integrates with: Path convexity detection system (`skia/impl/path.go`)
- Technology: Go, Skia C++ reference implementation
- Follows pattern: Direct port of C++ `Convexicator` struct from `SkPathPriv.cpp`
- Touch points: `path_models.go` (convexicator struct), `path.go` (convexity computation), `path_test.go` (test cases)

**Blocking Dependency:**
- Story 1.2 (Paint and Path Core Tests) - Task 5 is blocked until this bug is fixed
- Multiple test cases in `path_test.go` are skipped with `t.Skip()` due to convexicator bug

### Component Specifications

**Convexicator Implementation** (`skia/impl/path_models.go`):
- Current location: Lines 164-271
- C++ equivalent: `skia-source/src/core/SkPathPriv.cpp` lines 419-560
- Purpose: Track convexity state while iterating through a path contour
- Key methods:
  - `setMovePt(pt Point)` - Initialize with move point
  - `addPt(pt Point) bool` - Add point to contour
  - `addVec(curVec Point) bool` - Add direction vector
  - `close() bool` - Close the contour
  - `directionChange(curVec Point) DirChange` - Calculate direction change
  - `getFirstDirection() PathFirstDirection` - Get first direction

**Path Convexity Detection** (`skia/impl/path.go`):
- Uses convexicator in `computeConvexity()` method (line 691)
- Calls `state.addPt()`, `state.close()` to track contour
- Returns `PathConvexityConcave` if convexicator returns false

### C++ Reference Implementation

**Source:** `skia-source/src/core/SkPathPriv.cpp`

**Key Differences Identified:**

1. **`addPt()` method:**
   - C++ checks: `fLastVec.equals(0,0)` before initializing first vector
   - Go checks: `vec.X == 0 && vec.Y == 0` but may not handle doubled-back start correctly

2. **`addVec()` method:**
   - C++ reversal handling: `return ++fReversals < 3;` (increments then checks)
   - Go reversal handling: `c.reversals++; if c.reversals >= 3 { return false }` (increments then checks)
   - C++ uses `SkScalarSignAsInt(cross)` for direction sign
   - Go uses direct comparison `cross > 0` / `cross < 0`

3. **`directionChange()` method:**
   - C++ uses: `SkPoint::CrossProduct(fLastVec, curVec)`
   - C++ uses: `SkScalarSignAsInt(cross)` to get sign (returns 1 for positive, -1 for negative)
   - Go uses: `crossProduct(c.lastVec, curVec)` and direct comparison

4. **`close()` method:**
   - Both implementations call `addPt(fFirstPt)` then `addVec(fFirstVec)`
   - Need to verify the logic matches exactly

### Test Cases to Fix

**From `path_test.go`:**

1. **TestPath_Convexity** - Concave quadrilateral test (line 277)
2. **TestPath_Convexity** - Self-intersecting test (line 277)
3. **TestPath_Convexity2** - Bow tie test (line 358)
4. **TestPath_Convexity2** - Spiral test (line 379)
5. **TestPath_Convexity2** - Dent test (line 395)
6. **TestPath_Convexity2** - Degenerate concave test (line 409)
7. **TestPath_Convexity2** - Bad first vector test (line 423)
8. **TestPath_Convexity2** - False back edge test (line 441)
9. **TestPath_ConvexityCaching** - Concave detection test (line 484)

### Technical Constraints

**Floating-Point Precision:**
- Use `float32` (Go `Scalar`) to match C++ `float`
- Cross product calculations must match C++ exactly
- Direction sign detection must match C++ `SkScalarSignAsInt()` behavior

**Edge Cases:**
- Handle zero vectors correctly
- Handle doubled-back paths at start
- Handle paths that reverse direction (backwards edges)
- Handle paths with exactly 3 reversals (should be concave)
- Handle infinite/NaN values correctly

### Reference Documents

**C++ Source Reference:**
- Skia C++ source: `/home/jaco/SecondBrain/1-Projects/GoProjects/Development/skia-source`
- Convexicator implementation: `src/core/SkPathPriv.cpp` lines 419-560
- Path convexity computation: `src/core/SkPathPriv.cpp` lines 570-650

**Test Reference:**
- C++ tests: `skia-source/tests/PathTest.cpp` - `test_convexity()` and `test_convexity2()`
- Go tests: `skia/impl/path_test.go` - `TestPath_Convexity()` and `TestPath_Convexity2()`

---

## Testing

### Test File Location
- Test files: `*_test.go` alongside implementation in `skia/impl/`
- Test file: `skia/impl/path_test.go` (existing, needs updates)

### Test Standards
- Port tests from C++ `PathTest.cpp` (already ported, need to re-enable)
- Use tolerance-based comparison for floating-point (reuse `test_helpers.go`)
- Test all edge cases from C++ tests
- Verify no regression in existing convex shape tests

### Testing Frameworks
- Standard Go `testing` package
- Use `go test` for test execution
- Use `go test -cover` for coverage reports

### Specific Testing Requirements for This Story

1. **Re-enable Skipped Tests:**
   - Remove all `t.Skip()` calls related to convexicator bug
   - Verify previously skipped tests now pass

2. **Regression Testing:**
   - Run all existing convex shape tests
   - Verify triangle, square, circle tests still pass
   - Verify convexity caching tests still pass

3. **Edge Case Testing:**
   - Test concave quadrilateral
   - Test bow-tie (self-intersecting)
   - Test spiral (self-intersecting)
   - Test dent (concave)
   - Test paths with reversals
   - Test paths with zero vectors

4. **C++ Parity Verification:**
   - Compare test results with C++ test expectations
   - Verify direction change detection matches C++ exactly
   - Verify reversal counting matches C++ exactly

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Product Owner |

---

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

---

## QA Results

_To be populated by QA agent after review_

