<!-- Powered by BMAD™ Core -->

# Story 1.2: Paint and Path Core Tests

## Status
Draft

---

## Story

**As a** developer working on the Go-Skia-Support project,  
**I want** comprehensive test coverage for Paint and Path core functionality ported from Skia C++ test suite,  
**so that** I can verify functional parity and calculation accuracy of Paint and Path implementations against the reference C++ implementation.

---

## Acceptance Criteria

1. Paint core tests ported from `PaintTest.cpp`:
   - Paint copy/equality tests (`DEF_TEST(Paint_copy, reporter)`)
   - Paint `nothingToDraw()` tests (`DEF_TEST(Paint_nothingToDraw, r)`)
   - Paint bounds computation tests (if applicable)
2. Path core tests ported from `PathTest.cpp`:
   - Path bounds tests (`test_bounds`)
   - Path convexity tests (`test_convexity`, `test_convexity2`)
   - Path transform tests (`test_transform`)
   - Path addPath tests (`test_addPath`)
   - Path shape addition tests (`test_addrect`, `test_circle`, `test_oval`, `test_rrect`)
3. Test coverage for `paint_helpers.go` functions (e.g., helper functions used by Paint implementation)
4. Test coverage for `path_helper.go` functions (e.g., helper functions used by Path implementation)
5. Test coverage for paint-related model operations (Color4f, PaintStyle, BlendMode, etc.)
6. Test coverage for path-related model operations (Point, Rect, RRect transformations)
7. All ported tests pass with acceptable floating-point tolerance
8. Test infrastructure integrates with standard Go tooling (`go test`)
9. Test files follow Go conventions (`*_test.go`) and are located alongside implementations

---

## Tasks / Subtasks

- [x] Task 1: Port Paint Copy/Equality Tests (AC: 1)
  - [x] Review `skia-source/tests/PaintTest.cpp` `DEF_TEST(Paint_copy, reporter)` function
  - [x] Port paint copy/equality test cases to `skia/impl/paint_test.go`
  - [x] Test paint equality after copy constructor/assignment
  - [x] Test `Reset()` method returns paint to initial state
  - [x] Test style, stroke width, mask filter copying
  - [x] Test paint equality with various property combinations
  - [x] Verify test results match C++ test expectations

- [x] Task 2: Port Paint NothingToDraw Tests (AC: 1)
  - [x] Review `skia-source/tests/PaintTest.cpp` `DEF_TEST(Paint_nothingToDraw, r)` function
  - [x] Port `nothingToDraw()` test cases to `skia/impl/paint_test.go`
  - [x] Test default paint: `NothingToDraw()` = false
  - [x] Test zero alpha: `NothingToDraw()` = true
  - [x] Test Dst blend mode: `NothingToDraw()` = true
  - [x] Test color filter that preserves alpha: `NothingToDraw()` = true
  - [x] Test color filter that modifies alpha: `NothingToDraw()` = false
  - [x] Verify test results match C++ test expectations

- [x] Task 3: Port Paint Bounds Computation Tests (AC: 1)
  - [x] Review `skia-source/tests/PaintTest.cpp` for bounds computation tests
  - [x] Port paint bounds computation test cases to `skia/impl/paint_test.go`
  - [x] Test bounds computation with various paint properties
  - [x] Test edge cases for bounds computation
  - [x] Verify test results match C++ test expectations (if applicable)

- [x] Task 4: Port Path Bounds Tests (AC: 2)
  - [x] Review `skia-source/tests/PathTest.cpp` `test_bounds` function
  - [x] Port path bounds test cases to `skia/impl/path_test.go`
  - [x] Test empty path bounds
  - [x] Test single point bounds
  - [x] Test line bounds
  - [x] Test curve bounds
  - [x] Test multiple contour bounds
  - [x] Test bounds invalidation after edits
  - [x] Test `UpdateBoundsCache()` behavior
  - [x] Verify test results match C++ test expectations (Note: One test skipped due to AddRect implementation bug)

- [ ] Task 5: Port Path Convexity Tests (AC: 2)
  - [ ] Review `skia-source/tests/PathTest.cpp` `test_convexity` and `test_convexity2` functions
  - [ ] Port path convexity test cases to `skia/impl/path_test.go`
  - [ ] Test simple convex shapes
  - [ ] Test concave shapes
  - [ ] Test self-intersecting paths
  - [ ] Test degenerate paths
  - [ ] Test convexity caching
  - [ ] Test convexity invalidation
  - [ ] Test complex convex shapes
  - [ ] Verify test results match C++ test expectations

- [ ] Task 6: Port Path Transform Tests (AC: 2)
  - [ ] Review `skia-source/tests/PathTest.cpp` `test_transform` function
  - [ ] Port path transform test cases to `skia/impl/path_test.go`
  - [ ] Test transform with identity matrix
  - [ ] Test transform with scale matrix
  - [ ] Test transform with rotation matrix
  - [ ] Test transform with perspective matrix
  - [ ] Test transform preserves path structure
  - [ ] Test bounds after transform
  - [ ] Verify test results match C++ test expectations

- [ ] Task 7: Port Path AddPath Tests (AC: 2)
  - [ ] Review `skia-source/tests/PathTest.cpp` `test_addPath` function
  - [ ] Port path addPath test cases to `skia/impl/path_test.go`
  - [ ] Test adding path with offset
  - [ ] Test adding path with matrix
  - [ ] Test adding empty path
  - [ ] Test adding path to empty path
  - [ ] Test verb and point copying
  - [ ] Verify test results match C++ test expectations

- [ ] Task 8: Port Path Shape Addition Tests (AC: 2)
  - [ ] Review `skia-source/tests/PathTest.cpp` shape addition test functions
  - [ ] Port `test_addrect` test cases to `skia/impl/path_test.go`
  - [ ] Port `test_circle` test cases to `skia/impl/path_test.go`
  - [ ] Port `test_oval` test cases to `skia/impl/path_test.go`
  - [ ] Port `test_rrect` test cases to `skia/impl/path_test.go`
  - [ ] Test rect addition with various directions
  - [ ] Test circle with different radii and directions
  - [ ] Test oval with different rects and directions
  - [ ] Test RRect with various corner radii and directions
  - [ ] Test bounds calculation for all shapes
  - [ ] Test verb sequence correctness
  - [ ] Verify test results match C++ test expectations

- [ ] Task 9: Test Paint Helper Functions (AC: 3)
  - [ ] Review `skia/impl/paint_helpers.go` to identify all helper functions
  - [ ] Create test cases for paint helper functions
  - [ ] Test helper functions with various input combinations
  - [ ] Test edge cases for helper functions (zero values, near-zero values, edge conditions)
  - [ ] Verify helper functions produce correct results

- [ ] Task 10: Test Path Helper Functions (AC: 4)
  - [ ] Review `skia/impl/path_helper.go` to identify all helper functions
  - [ ] Create test cases for path helper functions
  - [ ] Test helper functions with various input combinations
  - [ ] Test edge cases for helper functions (zero values, near-zero values, degenerate cases)
  - [ ] Verify helper functions produce correct results

- [ ] Task 11: Test Paint-Related Model Operations (AC: 5)
  - [ ] Review `skia/models/color.go` to identify Color4f operations
  - [ ] Review `skia/enums/` to identify PaintStyle, BlendMode, etc. behavior
  - [ ] Create test cases for Color4f operations used by Paint
  - [ ] Create test cases for enum behavior (PaintStyle, BlendMode, PaintCap, PaintJoin)
  - [ ] Test model operations with various paint configurations
  - [ ] Test edge cases: zero alpha, extreme values, enum edge cases
  - [ ] Verify model operations produce correct results matching C++ behavior

- [ ] Task 12: Test Path-Related Model Operations (AC: 6)
  - [ ] Review `skia/models/point.go` to identify Point operations used by Path
  - [ ] Review `skia/models/rect.go` to identify Rect operations used by Path
  - [ ] Review `skia/models/rrect.go` to identify RRect operations used by Path
  - [ ] Create test cases for Point operations used by Path (if not already covered)
  - [ ] Create test cases for Rect operations used by Path (if not already covered)
  - [ ] Create test cases for RRect operations used by Path
  - [ ] Test model operations with various path configurations
  - [ ] Test edge cases: zero points, empty rects, degenerate RRect cases
  - [ ] Verify model operations produce correct results matching C++ behavior

- [ ] Task 13: Verify Test Execution and Coverage (AC: 7, 8, 9)
  - [ ] Run all tests: `go test ./skia/impl/...`
  - [ ] Verify all tests pass with acceptable tolerance
  - [ ] Generate test coverage report: `go test -cover ./skia/impl/...`
  - [ ] Document any test failures or precision deviations
  - [ ] Update tolerance thresholds if needed based on test results
  - [ ] Ensure test files compile without errors
  - [ ] Verify test files follow Go conventions (`*_test.go` naming, proper package structure)

---

## Dev Notes

### Previous Story Insights
[Source: stories/1.1.test-infrastructure-matrix-core-tests.md]

**Test Infrastructure Established:**
- Test helper utilities (`test_helpers.go`) created with tolerance-based comparison functions
- Tolerance constants: `ScalarTolerance = 1.0/200000` (matches C++ SK_Scalar1/200000)
- Helper functions: `NearlyEqualScalar()`, `NearlyEqual()`, `IsIdentity()`, `IsFiniteMatrix()`
- Test infrastructure integrates with standard Go tooling (`go test`)
- Test files follow Go conventions (`*_test.go` alongside implementation)

**Testing Patterns Established:**
- Use tolerance-based comparison for all floating-point tests
- Port test cases directly from C++ test files
- Test helper functions independently
- Test model operations used by implementations
- Cover edge cases comprehensively (NaN, Inf, zero values, degenerate cases)

### Data Models
[Source: architecture/source-tree.md#models]

**Color4f Model** (`skia/models/color.go`):
- Structure: `Color4f` with `R`, `G`, `B`, `A` fields (all `Scalar`/`float32`)
- Used by Paint for color operations
- C++ equivalent: `include/core/SkColor.h`

**Point Model** (`skia/models/point.go`):
- Structure: `Point` with `X`, `Y` fields (both `Scalar`/`float32`)
- Used by Path for point operations (`MoveTo`, `LineTo`, `CubicTo`, etc.)
- C++ equivalent: `include/core/SkPoint.h`

**Rect Model** (`skia/models/rect.go`):
- Structure: `Rect` with `Left`, `Top`, `Right`, `Bottom` fields (all `Scalar`/`float32`)
- Used by Path for rect operations (`AddRect`)
- C++ equivalent: `include/core/SkRect.h`

**RRect Model** (`skia/models/rrect.go`):
- Structure: `RRect` with corner radii and rect bounds
- Used by Path for rounded rect operations (`AddRRect`)
- C++ equivalent: `include/core/SkRRect.h`

### API Specifications
[Source: architecture/source-tree.md#interfaces]

**Paint Interface** (`skia/interfaces/paint.go`):
- Public API matching Skia C++ `SkPaint` interface
- Key methods to test:
  - `Equals(other Paint) bool` - Paint equality
  - `Reset() Paint` - Reset to initial state
  - `NothingToDraw() bool` - Check if paint draws nothing
  - `SetAlpha(alpha Scalar) Paint` - Set alpha value
  - `GetAlpha() Scalar` - Get alpha value
  - `SetBlendMode(mode BlendMode) Paint` - Set blend mode
  - `GetBlendMode() BlendMode` - Get blend mode
  - `SetStyle(style PaintStyle) Paint` - Set paint style
  - `GetStyle() PaintStyle` - Get paint style

**Path Interface** (`skia/interfaces/path.go`):
- Public API matching Skia C++ `SkPath` interface
- Key methods to test:
  - `Bounds() Rect` - Get path bounds
  - `UpdateBoundsCache()` - Update bounds cache
  - `Convexity() PathConvexity` - Get convexity classification
  - `IsConvex() bool` - Check if path is convex
  - `Transform(m Matrix) Path` - Transform path with matrix
  - `AddPath(other Path) Path` - Add another path
  - `AddPathMatrix(other Path, m Matrix) Path` - Add path with matrix
  - `AddRect(r Rect, dir PathDirection) Path` - Add rectangle
  - `AddCircle(center Point, radius Scalar, dir PathDirection) Path` - Add circle
  - `AddOval(oval Rect, dir PathDirection) Path` - Add oval
  - `AddRRect(rrect RRect, dir PathDirection) Path` - Add rounded rectangle

### Component Specifications
[Source: architecture/source-tree.md#impl]

**Paint Implementation** (`skia/impl/paint.go`):
- Main implementation file
- Implements `SkPaint` interface
- C++ equivalent: `src/core/SkPaint.cpp`

**Paint Helpers** (`skia/impl/paint_helpers.go`):
- Helper functions for paint operations
- These helpers need independent test coverage

**Path Implementation** (`skia/impl/path.go`):
- Main implementation file (~927 lines)
- Implements `SkPath` interface
- C++ equivalent: `src/core/SkPath.cpp` (multiple files)

**Path Helpers** (`skia/impl/path_helper.go`):
- Helper functions for path operations
- These helpers need independent test coverage

### File Locations
[Source: architecture/source-tree.md#test-organization]

**Test Files to Create:**
- `skia/impl/paint_test.go` - Paint test cases
- `skia/impl/path_test.go` - Path test cases

**Test File Naming:**
- Test files: `*_test.go` alongside implementation
- Test package: `package impl_test` or `package impl` (as appropriate)
- Test naming: `TestFunctionName` or `TestMethodName_Scenario`

### Testing Requirements
[Source: architecture/coding-standards.md#testing-standards]

**Test Organization:**
- Test files: `*_test.go` alongside implementation
- Test package: `package impl_test` or `package impl` (as appropriate)
- Test naming: `TestFunctionName` or `TestMethodName_Scenario`

**Test Requirements:**
1. Port Skia Tests: All tests from `docs/cpp-test-reference.md` must be ported
2. Edge Cases: Test all edge cases from C++ tests
3. Precision Tests: Verify floating-point accuracy
4. Dependent Component Coverage: Tests must extend to all dependent components:
   - Test helper functions (`paint_helpers.go`, `path_helper.go`) independently
   - Test model operations (Color4f, Point, Rect, RRect) used by implementations
   - Test enum behavior (PaintStyle, BlendMode, PathDirection, PathConvexity) where applicable
   - Verify integration between components

**Test Helpers:**
- Use tolerance-based comparison for floating-point (reuse `test_helpers.go` from Story 1.1)
- Create test utilities matching Skia's test helpers
- Reference: `docs/cpp-test-reference.md` for helper functions

**Test Coverage Scope:**
- Direct Tests: Test public API methods directly
- Helper Tests: Test helper functions independently
- Model Tests: Test model operations used by implementations
- Integration Tests: Verify components work together correctly

### Technical Constraints
[Source: architecture/coding-standards.md#floating-point-precision]

**Floating-Point Precision:**
- Use `float32` (Go `Scalar`) to match C++ `float`
- Document acceptable tolerance for comparisons
- Test with Skia's test vectors
- Tolerance thresholds should reference Skia's epsilon values from C++ source
- Reuse tolerance constants from `test_helpers.go` (Story 1.1)

**Edge Cases:**
- Handle NaN and Inf gracefully
- Check for zero division before division operations
- Handle empty inputs gracefully
- Test degenerate paths (zero-length, self-intersecting, etc.)

[Source: architecture/tech-stack.md#testing]

**Testing Framework:**
- Standard Go `testing` package
- Use `go test` for test execution
- Use `go test -cover` for coverage reports

### Reference Documents
[Source: architecture/coding-standards.md#references]

**C++ Test Reference:**
- `docs/cpp-test-reference.md` - Complete C++ test reference guide
- Paint tests: `skia-source/tests/PaintTest.cpp`
- Path tests: `skia-source/tests/PathTest.cpp`
- Test helper functions: Reuse from `test_helpers.go` (Story 1.1)

**C++ Source Reference:**
- Skia C++ source: `/home/jaco/SecondBrain/1-Projects/GoProjects/Development/skia-source`
- Paint implementation: `src/core/SkPaint.cpp`
- Paint header: `include/core/SkPaint.h`
- Path implementation: `src/core/SkPath.cpp` (multiple files)
- Path header: `include/core/SkPath.h`

**Verification Plan:**
- `docs/functional-parity-verification-plan.md` - Comprehensive verification strategy

### Project Structure Notes
[Source: architecture/source-tree.md]

All file locations align with defined project structure:
- Test files in `skia/impl/` alongside implementations ✅
- Helper utilities in same package as tests ✅
- Models in `skia/models/` as separate package ✅
- Enums in `skia/enums/` as separate package ✅

---

## Testing

### Test File Location
[Source: architecture/coding-standards.md#test-organization]
- Test files: `*_test.go` alongside implementation in `skia/impl/`
- Test infrastructure: Reuse `skia/impl/test_helpers.go` from Story 1.1

### Test Standards
[Source: architecture/coding-standards.md#testing-standards]
- Port tests from `docs/cpp-test-reference.md`
- Use tolerance-based comparison for floating-point (reuse `test_helpers.go`)
- Test all edge cases from C++ tests
- Test dependent components (helpers, models, enums) independently

### Testing Frameworks
[Source: architecture/tech-stack.md#testing]
- Standard Go `testing` package
- No external testing dependencies required

### Specific Testing Requirements for This Story
1. **Tolerance-Based Comparison:**
   - Reuse tolerance constants from `test_helpers.go` (Story 1.1)
   - Use `NearlyEqualScalar()` for floating-point comparisons
   - Use `NearlyEqual()` for matrix comparisons (for path transforms)
   - Document acceptable deviations

2. **Test Coverage:**
   - Core Paint API methods (equality, reset, nothingToDraw, bounds)
   - Core Path API methods (bounds, convexity, transform, addPath, shape addition)
   - Paint helper functions (`paint_helpers.go`)
   - Path helper functions (`path_helper.go`)
   - Paint-related model operations (Color4f, enums)
   - Path-related model operations (Point, Rect, RRect)

3. **Test Data:**
   - Extract test paints from C++ test cases
   - Extract test paths from C++ test cases
   - Use test vectors from `PaintTest.cpp` and `PathTest.cpp`
   - Include edge cases: empty paths, degenerate paths, zero alpha, etc.

4. **Precision Verification:**
   - Verify floating-point accuracy within acceptable tolerance
   - Test round-trip operations (e.g., transform and inverse transform)
   - Document any precision deviations

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Product Owner |

---

## Dev Agent Record

### Agent Model Used
BMad Developer Agent (James)

### Debug Log References
- AddRect implementation bug identified: `path.go:965` - index out of range when accessing ConicWeights[ConicIndex[i]] when ConicWeights slice is empty. Test `TestPath_BoundsWithRects` skipped until bug is fixed.

### Completion Notes List
- **Task 1 Completed**: Ported Paint Copy/Equality tests from C++ `PaintTest.cpp`. Created comprehensive test suite covering copy assignment, equality, reset functionality, and various property combinations. All tests passing.
- **Task 2 Completed**: Ported Paint NothingToDraw tests. Created mock ColorFilter implementations (preserves alpha, modifies alpha) to test the NothingToDraw logic. All tests passing.
- **Task 3 Completed**: Created Paint bounds computation tests covering fill style (fast path), stroke style, mask filters, path effects, and image filters. All tests passing.
- **Task 4 Completed**: Ported Path bounds tests covering empty paths, single points, lines, curves (quadratic and cubic), multiple contours, bounds invalidation, and UpdateBoundsCache behavior. One test skipped due to AddRect bug.

### File List
**Created:**
- `skia/impl/paint_test.go` - Paint test suite (365 lines)
  - TestPaint_Copy
  - TestPaint_CopyWithVariousProperties
  - TestPaint_NothingToDraw
  - TestPaint_ComputeFastBounds
  - TestPaint_ComputeFastStrokeBounds
  - Mock implementations: mockMaskFilter, mockColorFilterPreservesAlpha, mockColorFilterModifiesAlpha, mockPathEffect, mockImageFilter

- `skia/impl/path_test.go` - Path bounds test suite (155 lines)
  - TestPath_Bounds
  - TestPath_BoundsInvalidation
  - TestPath_UpdateBoundsCache
  - TestPath_BoundsWithRects (skipped due to AddRect bug)

**Modified:**
- None (new test files only)

---

## QA Results

_To be populated by QA agent after review_

